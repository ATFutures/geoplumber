---
title: "geoplumber: R package web framework"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

`geoplumber` depends only on [`plumber`](https://www.rplumber.io) R package to enable building web applicaitons using R and currently ReactJS. It uses `npm` but this is by no means a preference. It is a rapid developmened available skill utilisation choice.

Currently there is no database at the backend, this is simply because we are at the beginning of this process and there will be need to use one or more. Therefore, as things stand it is a two tier architecture and prefers the `flux` one. That is data flow should be one directional and follow the "React" paradigm.

In terms of npm pacakges, it relies on Facebook's "create-react-app" (CRA) `npm` package to create the basic structure of the front end. But there is basic code to replace this and assemble a React package as it will be demonstrated in this vignette.

In terms of web mapping, the landscape is not huge. Being an open source pacakge, we chose the simplicity of `leafletjs`. Thanks to `react-leaflet` this is was simple to integrate into a ReactJS app.

## Getting started
So given some dataset such as the `traffic` included in this package let us get a web application up and running where we can see some `geojson` data on a map.

```{r traffic}
library(geoplumber)
html_file = gp_map(traffic, browse_map = FALSE, dest_path = getwd())
htmltools::includeHTML(html_file)
```

```{r hidden, echo=FALSE, message=FALSE}
file.remove(html_file)
```

As the default `gp_create` function uses `create-react-app`, let us assemble an app using `gp_cra_init`:

```{r gp_cra_init}
path = file.path(tempdir(), "new_app")
# make sure that exists
dir.create(path)
gp_cra_init(path = path)
# check if that is the case
gp_is_wd_geoplumber(path = path)

```

Now that `path` is a valid `geoplumber` application, quick look into it:
```{r gp-app-structure}
list.files(path)
list.files(file.path(path, "R"))
```

The `R/plumber.R` is the only backend script that would be executed ina fresh geoplumber app. Using the underlying `plumber` package, we can inspect what is in the `R/plumber.R` file:

```{r plumber.R}
# we must change dir into a gp path
ow <- setwd(path)
r <- gp_plumb(run = FALSE)
length(r$endpoints[[1]]) # it should be 5
```

There is a default endpoint where a message is echoed by the server, we can test this using:

```{r plumber.R2}
response <- r$endpoints[[1]][[1]]$exec()
response$msg # it should be: "The message is: 'nothing given'"
```

### serve data

This is the last lines of the `R/plumber.R` file, as stated above, makes up the backend:

```{r cat-plumber.R}
ow <- setwd(path)
tail(readLines("R/plumber.R"))
```

We can add the following to the end of the file and rerun `gp_plumb`:
```{r eval=FALSE}
#' Serve geoplumber::traffic from /api/data
#' @get /api/data
get_traffic <- function(res) {
  geojson <- geojsonsf::sf_geojson(geoplumber::traffic)
  res$body <- geojson
  res
}
```

```{r hidden2, echo=FALSE, message=FALSE, results=FALSE}
ow <- setwd(path)
plumberR <- "R/plumber.R"
if(!file.exists(plumberR)) {
  stop("Error: cannot find R/plumber.R file.")
}
# write
endpoint <- c(
 "#' vignette added endpoint",
 "#'",
 "#' Serve geoplumber::traffic from /api/data",
 "#' @get /api/data",
 "get_traffic <- function(res) {",
 "  geojson <- geojsonsf::sf_geojson(geoplumber::traffic)",
 "  res$body <- geojson",
 "  res",
 "}"
 )
write(endpoint, file = plumberR, append = TRUE)
```
Let us use a helper function from `geoplumber` called `gp_endpoint_from_clip`:

```{r gp_endpoint_from_clip, eval=FALSE}
ow <- setwd(path)
old_clip <- clipr::read_clip()
# adding below to clipboard
clipr::write_clip(c(
 "#' vignette added endpoint",
 "#'",
 "#' Serve geoplumber::traffic from /api/data",
 "#' @get /api/data",
 "get_traffic <- function(res) {",
 "  geojson <- geojsonsf::sf_geojson(geoplumber::traffic)",
 "  res$body <- geojson",
 "  res",
 "}"
 ))
gp_endpoint_from_clip()
clipr::write_clip(old_clip)
```
check if that worked:
```{r cat-plumber.R2}
ow <- setwd(path)
tail(readLines("R/plumber.R"))
```

That did work. Now, we should have an extra endpoint:
```{r plumber.R3, message=FALSE}
# we must change dir into a gp path
ow <- setwd(path)
r <- gp_plumb(run = FALSE)
length(r$endpoints[[1]]) # it should now be 6
```

Now, we cannot simulate the last endpoint by executing it as we have done above. But if you would like to run `gp_plumb`, you should now have `geojson` object returned to you if you visist `localhost:8000/api/data` URL on your browser or `curl` it.

What about the front end? Well, we need to consume that URL somehow. There is few functions to assist with composing React components. One of them is called `gp_add_geojson` which takes a URL and can "render" the data from it:

```{r gp_add_geojson}
ow <- setwd(path)
gp_add_geojson(endpoint = "/api/data") # which is the default
```
A peek into the main React component called "Welcome" to see if we have a component called `GeoJSONComponent`:
```{r cat-plumber.R3}
ow <- setwd(path)
tail(readLines("src/Welcome.js"))
```

Yep, that looks good. We are now ready to build our front end and consume the data served from the R backend:

```{r npm-i, eval=FALSE}
ow <- setwd(path)
gp_build()
## Running: npm run build
## Looks like first run, installing npm packages...
## Running: gp_npm_install()
## Now trying to build: npm run build
## Standard output from create-react-app above works.
## To run the geoplumber app: gp_plumb()
```

Now, we have installed the required dependancies of the npm package and we can run the application using:

```{r finally, eval=FALSE}
gp_plumb()
# visit localhost:8000 to see the application
```

## Analysing an sf object

## Adding front end React components

```{r cleanup, echo=FALSE, message=FALSE}
setwd(ow)
unlink(path, recursive = TRUE)
```

## Underlying stack

As geoplumber uses both R and Node, currently R v3.4 is the minimum, we will do all we can to make it backward compatible both in R and node. As for node, whatever the needs of Facebook's `create-react-app` is. For instructions on installing node on your OS please refer to the [NodeJS official docs](https://nodejs.org/en/download/package-manager/).




